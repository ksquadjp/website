<!DOCTYPE html>
<html lang="ja">
  <head>
    <!-- Google tag (gtag.js) --><script type="text/partytown" async src="https://www.googletagmanager.com/gtag/js?id=G-XCCQNP1TC3"></script>
<script type="text/partytown">
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());
  gtag("config", "G-XCCQNP1TC3");
</script>

<!-- Global Metadata --><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="sitemap" href="/sitemap-index.xml">
<link rel="author" href="/humans.txt">
<link rel="icon" type="image/png" href="/icons/favicon32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/icons/favicon64.png" sizes="64x64">
<link rel="icon" type="image/png" href="/icons/favicon128.png" sizes="128x128">
<meta name="generator" content="Astro v2.4.3">

<!-- Canonical URL -->
<link rel="canonical" href="https://ksquad.jp/blog/2023-03-31-declarative-migration/">

<!-- Primary Meta Tags -->
<title>宣言的DBテーブル定義のススメ</title>
<meta name="title" content="宣言的DBテーブル定義のススメ">
<meta name="description">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://ksquad.jp/blog/2023-03-31-declarative-migration/">
<meta property="og:title" content="宣言的DBテーブル定義のススメ">
<meta property="og:description">
<meta property="og:image" content="https://camo.githubusercontent.com/de83ba9b0d38a369a656064a9bd350839f063f46ecca2f69c3c42f4483f83228/68747470733a2f2f61746c6173676f2e696f2f75706c6f6164732f696d616765732f676f706865722e706e67">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://ksquad.jp/blog/2023-03-31-declarative-migration/">
<meta property="twitter:title" content="宣言的DBテーブル定義のススメ">
<meta property="twitter:description">
<meta property="twitter:image" content="https://camo.githubusercontent.com/de83ba9b0d38a369a656064a9bd350839f063f46ecca2f69c3c42f4483f83228/68747470733a2f2f61746c6173676f2e696f2f75706c6f6164732f696d616765732f676f706865722e706e67">
    
  <link rel="stylesheet" href="/_astro/2023-01-12-update-lp-with-nextjs.2229edda.css" />
<link rel="stylesheet" href="/_astro/2023-01-12-update-lp-with-nextjs.4a83be73.css" /><script>!(function(w,p,f,c){c=w[p]=Object.assign(w[p]||{},{"lib":"/~partytown/","debug":false});c[f]=(c[f]||[]).concat(["dataLayer.push"])})(window,'partytown','forward');/* Partytown 0.7.6 - MIT builder.io */
!function(t,e,n,i,r,o,a,d,s,c,p,l){function u(){l||(l=1,"/"==(a=(o.lib||"/~partytown/")+(o.debug?"debug/":""))[0]&&(s=e.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(d=setTimeout(f,1e4),e.addEventListener("pt0",w),r?h(1):n.serviceWorker?n.serviceWorker.register(a+(o.swPath||"partytown-sw.js"),{scope:a}).then((function(t){t.active?h():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&h()}))}),console.error):f())))}function h(t){c=e.createElement(t?"script":"iframe"),t||(c.setAttribute("style","display:block;width:0;height:0;border:0;visibility:hidden"),c.setAttribute("aria-hidden",!0)),c.src=a+"partytown-"+(t?"atomics.js?v=0.7.6":"sandbox-sw.html?"+Date.now()),e.body.appendChild(c)}function f(n,r){for(w(),i==t&&(o.forward||[]).map((function(e){delete t[e.split(".")[0]]})),n=0;n<s.length;n++)(r=e.createElement("script")).innerHTML=s[n].innerHTML,e.head.appendChild(r);c&&c.parentNode.removeChild(c)}function w(){clearTimeout(d)}o=t.partytown||{},i==t&&(o.forward||[]).map((function(e){p=t,e.split(".").map((function(e,n,i){p=p[i[n]]=n+1<i.length?"push"==i[n+1]?[]:p[i[n]]||{}:function(){(t._ptf=t._ptf||[]).push(i,arguments)}}))})),"complete"==e.readyState?u():(t.addEventListener("DOMContentLoaded",u),t.addEventListener("load",u))}(window,document,navigator,top,window.crossOriginIsolated);</script></head>

  <body>
    <nav class="rounded border-gray-200 bg-white px-2 py-2.5 sm:px-4"><div class="container mx-auto flex flex-wrap items-center justify-between"><a href="/" class="flex items-center"><img src="/logos/ksquad_logo.svg" class="mr-3 h-8" alt="K Squad" /></a><button type="button" class="ml-3 inline-flex items-center rounded-lg p-2 text-sm focus:outline-none focus:ring-gray-200 md:hidden"><span class="sr-only">Open main menu</span><svg class="h-6 w-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clipRule="evenodd"></path></svg></button><div class="hidden md:inline-block w-full md:w-auto lg:order-1 lg:w-auto" id="mobile-navbar"><ul class="mt-4 flex flex-col rounded-lg p-4 md:mt-0 md:flex-row md:space-x-8 md:border-0 md:bg-white md:text-sm md:font-medium"><li><a href="/company" class="block rounded py-2 pl-3 pr-4 text-xl text-gray-700 md:border-0 md:p-0 md:hover:bg-transparent">Company</a></li><li><a href="/news" class="block rounded py-2 pl-3 pr-4 text-xl text-gray-700 md:border-0 md:p-0 md:hover:bg-transparent">News</a></li><li><a href="/blog" class="block rounded py-2 pl-3 pr-4 text-xl text-gray-700 md:border-0 md:p-0 md:hover:bg-transparent">Blog</a></li><li><a href="/careers" class="block rounded py-2 pl-3 pr-4 text-xl text-gray-700 md:border-0 md:p-0 md:hover:bg-transparent">Careers</a></li><li><a href="/contact" class="block rounded py-2 pl-3 pr-4 text-xl text-gray-700 md:border-0 md:p-0 md:hover:bg-transparent">Contact</a></li></ul></div></div></nav>
    <main>
      <article>
        <div class="container mx-auto px-5">
  
          <h1 class="py-8 text-4xl font-bold">宣言的DBテーブル定義のススメ</h1>
          <div class="py-2">
            <time class="">2023-03-31</time>
          </div>
          <div class="relative">
            <img alt="" class="w-screen" fit="cover" width="1200" height="600" src="/_astro/68747470733a2f2f61746c6173676f2e696f2f75706c6f6164732f696d616765732f676f706865722e706e67_Z1oYxxn.webp" loading="lazy" decoding="async">
          </div>
          <hr>
          <div class="markdown">
            <h2 id="web開発プロジェクトでのdbマイグレーションの運用面の課題">Web開発プロジェクトでのDBマイグレーションの運用面の課題</h2>
<p>代表の<a href="https://twitter.com/komi_edtr_1230">komi</a>です。</p>
<p>Webアプリを開発するとき、一般的にWebフレームワークを使うことが多いと思います。
RubyならRuby on Rails, JavaならSpring Boot、PythonではFastAPIやDjangoなど。</p>
<p>ビジネスがいざ動き始めてプロジェクトが走り始めたとき、ビジネスサイドの状況次第でプロジェクトの要件は頻繁に変わります。
例えばユーザーに管理画面でもっと情報見せたいからフロントエンドに渡すJSONのフィールドを増やすなどが起こり得ます。</p>
<p>そうした要件の変更の中で、テーブルを新しく生やしたり既存テーブルに新しくカラムを追加するなどDBに変更を入れることも頻繁に起きます。</p>
<p>DBに変更を入れる際、<code>マイグレーション</code>を行う必要がありますね。</p>
<p>Django等でマイグレーションをする際、モデルのコードとDBの状態を見て差分を検知した上でマイグレーション用にSQLを生成します。
プロジェクトが長期化してマイグレーションを複数行っていくと、マイグレーションの際に生成したファイルがたくさん増えていきます。</p>
<p><img src="https://i.stack.imgur.com/tscCr.png" alt="img"></p>
<p>K Squadでは様々なお客さまへ技術顧問を行っているのですが、先日Djangoプロジェクトにおいて複数のメンバーが同じテーブルに対して異なる変更をするケースが発生し、マイグレーションファイルがコンフリクトしてマイグレーションが失敗するという事件が発生していました。</p>
<p>なぜそんなことが起きていたかというと、マイグレーションファイルが増えるのを嫌がって過去のマイグレーションファイルをgitignoreしていたというのが原因でした。</p>
<p>こうした事件を避けるべく、過去のマイグレーションファイルをGitで管理し、同時にIssue分担を上手にやることによってカバーすることができます。</p>
<p>というように基本的にマイグレーションでの事故は運用で努力すれば問題ないのですが、ところで過去のマイグレーションファイルが増えることが嫌だと感じる人は一定数いるのではないでしょうか？</p>
<p>そこで今回このような手続的なマイグレーション手法ではなく宣言的なマイグレーション手法を提案しようと思います。</p>
<h2 id="宣言的マイグレーション">宣言的マイグレーション</h2>
<p>手続的マイグレーションと宣言的マイグレーションは記述された通りにDBの定義を更新するという観点で、本質的には同じです。</p>
<p>しかし手続的なアプローチでは<code>現在のコードと現在のテーブルの状態に差分があるか</code>に着目するのに対し、宣言的なアプローチでは<code>現在のコードの通りになっているか</code>に着目するという観点で異なります。</p>
<p>具体例を出すと、</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">CREATE</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">TABLE</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">users</span><span style="color: #E1E4E8"> (</span></span>
<span class="line"><span style="color: #E1E4E8">  id </span><span style="color: #F97583">BIGSERIAL</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">PRIMARY KEY</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">name</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">TEXT</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  created_at </span><span style="color: #F97583">TIMESTAMP</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">NOT NULL</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">DEFAULT</span><span style="color: #E1E4E8"> CURRENT_TIMESTAMP,</span></span>
<span class="line"><span style="color: #E1E4E8">  updated_at </span><span style="color: #F97583">TIMESTAMP</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">NOT NULL</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">DEFAULT</span><span style="color: #E1E4E8"> CURRENT_TIMESTAMP</span></span>
<span class="line"><span style="color: #E1E4E8">);</span></span></code></pre>
<p>の通りにマイグレーションをしたあとスキーマの状態を</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">CREATE</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">TABLE</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">users</span><span style="color: #E1E4E8"> (</span></span>
<span class="line"><span style="color: #E1E4E8">  id </span><span style="color: #F97583">BIGSERIAL</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">PRIMARY KEY</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">name</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">TEXT</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  prefecture </span><span style="color: #F97583">TEXT</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">NOT NULL</span><span style="color: #E1E4E8">,  </span><span style="color: #6A737D">-- &#x3C;-- これが追加された</span></span>
<span class="line"><span style="color: #E1E4E8">  created_at </span><span style="color: #F97583">TIMESTAMP</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">NOT NULL</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">DEFAULT</span><span style="color: #E1E4E8"> CURRENT_TIMESTAMP,</span></span>
<span class="line"><span style="color: #E1E4E8">  updated_at </span><span style="color: #F97583">TIMESTAMP</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">NOT NULL</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">DEFAULT</span><span style="color: #E1E4E8"> CURRENT_TIMESTAMP</span></span>
<span class="line"><span style="color: #E1E4E8">);</span></span></code></pre>
<p>と変更し(<code>prefecture</code>カラムを加えた)、その後</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">CREATE</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">TABLE</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">users</span><span style="color: #E1E4E8"> (</span></span>
<span class="line"><span style="color: #E1E4E8">  id </span><span style="color: #F97583">BIGSERIAL</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">PRIMARY KEY</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">name</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">TEXT</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  created_at </span><span style="color: #F97583">TIMESTAMP</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">NOT NULL</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">DEFAULT</span><span style="color: #E1E4E8"> CURRENT_TIMESTAMP,</span></span>
<span class="line"><span style="color: #E1E4E8">  updated_at </span><span style="color: #F97583">TIMESTAMP</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">NOT NULL</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">DEFAULT</span><span style="color: #E1E4E8"> CURRENT_TIMESTAMP</span></span>
<span class="line"><span style="color: #E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">CREATE</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">TABLE</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">user_addresses</span><span style="color: #E1E4E8"> (</span></span>
<span class="line"><span style="color: #E1E4E8">  id </span><span style="color: #F97583">BIGSERIAL</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">PRIMARY KEY</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  user_id </span><span style="color: #F97583">BIGINT</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">PRIMARY KEY</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">REFERENCES</span><span style="color: #E1E4E8"> users (id) </span><span style="color: #F97583">ON DELETE CASCADE</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  prefecture </span><span style="color: #F97583">TEXT</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">NOT NULL</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  created_at </span><span style="color: #F97583">TIMESTAMP</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">NOT NULL</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">DEFAULT</span><span style="color: #E1E4E8"> CURRENT_TIMESTAMP,</span></span>
<span class="line"><span style="color: #E1E4E8">  updated_at </span><span style="color: #F97583">TIMESTAMP</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">NOT NULL</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">DEFAULT</span><span style="color: #E1E4E8"> CURRENT_TIMESTAMP</span></span>
<span class="line"><span style="color: #E1E4E8">);</span></span></code></pre>
<p>としたとします(<code>prefecture</code>カラムを<code>users</code>テーブルに生やさず別のテーブルに切り出した)。</p>
<p>このとき最初と最後の状態を比較すると結果的に<code>user_addresses</code>テーブルが生えただけなのですが、手続的なアプローチだと</p>
<ul>
<li><code>ALTER TABLE users ADD prefecture ....</code> として<code>prefecture</code>カラムを生やす</li>
<li><code>ALTER TABLE users DROP COLUMN prefecture ....</code>とテーブルから<code>prefecture</code>カラムを削除したあと<code>CREATE TABLE user_addresses ....</code>とテーブル作成DDL</li>
</ul>
<p>というように無駄な過去のマイグレーションファイルが生成されます。</p>
<p>宣言的マイグレーションでは、現在のコードの状態と現在のDBの状態を比較して内部的に変更を検知した上でマイグレーションを行うので無駄なマイグレーションファイルが生成されることはありません。</p>
<h2 id="宣言的マイグレーションを行うツール">宣言的マイグレーションを行うツール</h2>
<p>有名どころだと<a href="https://github.com/ariga/atlas">atlas</a>や<a href="https://github.com/k0kubun/sqldef">sqldef</a>があります。</p>
<p>それぞれSQLファイルにてテーブル定義を記述することができますが、atlasはHCLでも記述することができ、同時にエラーメッセージがわかりやすいところがポイントです。</p>
<p>一方でsqldefはSQL Serverに対応しているところがポイントで(<a href="https://techblog.zozo.com/entry/database-migration-with-sqldef">ZOZOのエンジニアの方が対応してくれた</a>ようです)、開発者が<a href="https://twitter.com/k0kubun">k0kubun</a>さんという日本人の方なので困ったらTwitterでふらっと相談できるというのが良さだと思います。</p>
<p>これらのツールを利用してマイグレーションおよびスキーマ管理を行います。</p>
<h2 id="モデルのコードへ出力">モデルのコードへ出力</h2>
<p>Webフレームワークを利用しているとモデル(DBに保存されているデータの部分)のコードを記述しなくてはいけません。</p>
<p>しかしスキーマをSQLで管理していて、ここでまたPython等でモデルのコードを書くのはDBの定義を2回しているようなもので無駄だし楽しい仕事ではありません。</p>
<p>つまりモデルのコードを自動生成したいですよね？</p>
<p>Djangoのプロジェクトの場合、<code>inspectdb</code>コマンドというのが用意されており、DBをスキャンしてモデルのコードを自動生成してくれます。</p>
<p>また、PythonでORMとしてSQLAlchemyを利用している場合は<a href="https://github.com/agronholm/sqlacodegen">sqlacodegen</a>というCLIツールが提供されており、FastAPI等ではこちらを使うのが良いでしょう。</p>
<p>Goでは<a href="https://github.com/go-gorm/gen">Gen</a>や<a href="https://sqlc.dev/">sqlc</a>いったモデルジェネレータが存在します。</p>
<p>Rubyについては筆者は詳しくないので良いツールがあれば教えてください。</p>
<h2 id="まとめ">まとめ</h2>
<p>今回は宣言的マイグレーションを紹介させていただきました。</p>
<p>マイグレーション自体についてはatlasといった外部ツールを利用するのでアプリケーションコード生成などやることは多少増えます。</p>
<p>一方でテーブルの状態を宣言的に管理することによってDBの状態の変更履歴をGitの履歴と同一化することができ、DBの管理をアプリケーションコードと同様の形式にすることができます。
つまりロールバックするときは<code>git revert</code>すれば良いのです。</p>
<p>もし手続的マイグレーションにツラさを感じた場合は宣言的マイグレーションを試してみてください。</p>
          </div>
          <div class="container mx-auto px-5">
  
</div>
        
</div>
      </article>
      <footer class="border-t border-neutral-200 bg-neutral-50">
  <div class="mx-auto flex flex-col items-center justify-around p-5 lg:flex-row">
    <a href="/" class="mb-10 leading-tight lg:mb-0 lg:pr-4">
      <img src="/logos/ksquad_logo.svg" class="h-9" alt="K Squad">
    </a>
    <div class="flex flex-col items-center justify-center lg:flex-row lg:pl-4">
      <a href="/contact" class="mx-3 mb-6 border border-black bg-black py-3 px-12 font-bold text-white transition-colors duration-200 hover:bg-white hover:text-black lg:mb-0 lg:px-8">
        お問い合わせ
      </a>
      <a href="/careers" class="mx-3 font-bold hover:underline"> 採用情報</a>
    </div>
  </div>
  <p class="py-5 text-center">
    &copy; 2023 K Squad LLC. All rights reserved.
  </p>
</footer>
    </main>
  </body></html>